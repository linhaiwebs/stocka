version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aistock-us-page-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${BACKEND_PORT:-3001}
      - HOST=${HOST:-0.0.0.0}
      - SERVER_SUBDOMAIN=${SERVER_SUBDOMAIN}
      - FRONTEND_MAIN_DOMAIN=${FRONTEND_MAIN_DOMAIN:-example.com}
      - FRONTEND_DEV_URL=${FRONTEND_DEV_URL}
      - DATABASE_PATH=${DATABASE_PATH:-/app/data/landing_pages.db}
      - DATABASE_BACKUP_PATH=${DATABASE_BACKUP_PATH:-/app/backups}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-8h}
      - BCRYPT_ROUNDS=${BCRYPT_ROUNDS:-10}
      - CORS_ADMIN_ORIGINS=${CORS_ADMIN_ORIGINS}
      - CORS_TEMPLATE_ORIGINS=${CORS_TEMPLATE_ORIGINS}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-60000}
      - RATE_LIMIT_TEMPLATE_MAX=${RATE_LIMIT_TEMPLATE_MAX:-100}
      - RATE_LIMIT_ADMIN_MAX=${RATE_LIMIT_ADMIN_MAX:-1000}
      - RATE_LIMIT_PUBLIC_MAX=${RATE_LIMIT_PUBLIC_MAX:-500}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - AUTO_SEED_COMPONENT_CODE=${AUTO_SEED_COMPONENT_CODE:-true}
      - FORCE_RESEED_COMPONENT_CODE=${FORCE_RESEED_COMPONENT_CODE:-false}
      - TEMPLATES_DIR=${TEMPLATES_DIR:-/app/templates}
    volumes:
      - backend-data:/app/data
      - backend-backups:/app/backups
      - ./templates:/app/templates:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "sh", "-c", "node -e \"require('http').get('http://localhost:${PORT:-3001}/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL}
        - VITE_API_SUBDOMAIN=${VITE_API_SUBDOMAIN}
        - VITE_API_TIMEOUT=${VITE_API_TIMEOUT:-30000}
        - VITE_DOMAIN_MAIN=${VITE_DOMAIN_MAIN}
        - VITE_DOMAIN_ADMIN=${VITE_DOMAIN_ADMIN}
        - VITE_ENABLE_ANALYTICS=${VITE_ENABLE_ANALYTICS:-true}
        - VITE_ENABLE_CONVERSION_TRACKING=${VITE_ENABLE_CONVERSION_TRACKING:-true}
        - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
        - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
    container_name: aistock-us-page-frontend
    restart: unless-stopped
    environment:
      - BACKEND_PORT=${BACKEND_PORT:-3001}
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      - backend
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  app-network:
    driver: bridge

volumes:
  backend-data:
    driver: local
  backend-backups:
    driver: local
